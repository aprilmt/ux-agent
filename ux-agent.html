<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UX AI Agent</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: white;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            max-width: 1000px;
            width: 100%;
            padding: 40px 20px;
            text-align: center;
        }
        
        /* Icon and Branding */
        .icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .brand-title {
            font-size: 2.5em;
            font-weight: bold;
            color: #4a4a4a;
            margin: 0 0 10px 0;
            letter-spacing: -0.02em;
        }
        
        .author {
            font-size: 1em;
            color: #999;
            margin: 0 0 20px 0;
        }
        
        .function-desc {
            font-size: 1.2em;
            color: #4a4a4a;
            margin: 0 0 20px 0;
            font-weight: 500;
            display: block; /* Show by default */
        }
        
        .function-desc.hide {
            display: none; /* Hide when class 'hide' is added */
        }
        
        .author-desc {
            font-size: 0.9em;
            color: #6c757d;
            margin: 0 0 40px 0;
            font-weight: 400;
            display: block; /* Show by default */
        }
        
        .author-desc.hide {
            display: none; /* Hide when class 'hide' is added */
        }
        
        /* Prompt Boxes */
        .prompt-grid {
            display: grid; /* Show by default */
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin: 40px 0;
        }
        
        .prompt-grid.hide {
            display: none; /* Hide when class 'hide' is added */
        }
        
        .prompt-box {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 30px 20px;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .prompt-box:hover {
            border-color: #3885FF;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(56,133,255,0.2);
        }
        
        .prompt-box.selected {
            border-color: #3885FF;
            background: #f8f8f8;
        }
        
        .prompt-text {
            color: #4a4a4a;
            font-size: 0.95em;
            line-height: 1.4;
            margin: 0;
        }
        
        /* Chat Interface */
        .chat-section {
            margin-top: 60px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .chat-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .chat-input {
            flex: 1;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            outline: none;
        }
        
        .chat-input:focus {
            border-color: #4a4a4a;
        }
        
        .send-button {
            background: #4a4a4a;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.2s;
        }
        
        .send-button:hover {
            background: #333;
        }
        
        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        #new-chat-button:disabled {
            background: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
            border-color: #dee2e6;
            opacity: 0.6;
        }
        
        .response-area {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            min-height: 300px;
            max-height: 800px;
            overflow-y: auto;
            text-align: left;
            margin-bottom: 20px;
            display: none !important;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease-in-out;
        }
        
        .response-area.show {
            display: block !important;
            opacity: 1;
            transform: translateY(0);
        }
        
        .response-message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            width: 100%;
            opacity: 0;
            transform: translateY(10px);
            animation: messageSlideIn 0.4s ease-out forwards;
        }
        
        @keyframes messageSlideIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .ai-message {
            flex-direction: row;
            width: 100%;
        }
        
        .user-message {
            flex-direction: row;
            width: 100%;
        }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
        }
        
        .user-avatar {
            background: #007bff;
            color: white;
        }
        
        .ai-avatar {
            background: #f8f9fa;
            color: #6c757d;
            border: 2px solid #e9ecef;
        }
        
        .message-content {
            flex: 1;
            padding-left: 12px;
        }
        
        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }
        
        .message-sender {
            font-weight: bold;
            font-size: 14px;
            color: #333;
        }
        
        .message-time {
            font-size: 12px;
            color: #6c757d;
        }
        
        .ai-badge {
            background: #e9ecef;
            color: #6c757d;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .message-bubble {
            background: white;
            border-radius: 18px;
            padding: 12px 16px 12px 20px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
            text-align: left;
            display: inline-block;
            word-wrap: break-word;
        }
        
        .message-bubble h1 {
            font-size: 1.5em;
            font-weight: bold;
            margin: 1em 0 0.5em 0;
            color: #333;
        }

        .message-bubble h2 {
            font-size: 1.3em;
            font-weight: bold;
            margin: 0.8em 0 0.4em 0;
            color: #333;
        }

        .message-bubble h3 {
            font-size: 1.1em;
            font-weight: bold;
            margin: 0.6em 0 0.3em 0;
            color: #333;
        }

        .message-bubble strong {
            font-weight: bold;
            color: #333;
        }
        
        .message-bubble em {
            font-style: italic;
        }
        
        .message-bubble li {
            margin: 0.1em 0;
            padding-left: 1em;
        }
        
        .message-bubble p {
            margin: 0.5em 0;
            line-height: 1.5;
        }
        
        /* Recommended Prompts */
        .recommended-prompts {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #e9ecef;
        }
        
        .recommended-header {
            font-size: 14px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 12px;
        }
        
        .recommended-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .recommended-prompt {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px 12px;
            font-size: 14px;
            color: #495057;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .recommended-prompt:hover {
            background: #e3f2fd;
            border-color: #2196f3;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .user-message .message-content {
            text-align: left;
            flex: 1;
        }
        
        .user-message .message-bubble {
            background: #007bff !important;
            color: white !important;
            border: none !important;
            max-width: 70% !important;
            width: auto !important;
            margin-left: 0 !important;
            margin-right: auto !important;
            display: inline-block !important;
            box-sizing: border-box !important;
        }
        
        .ai-message .message-content {
            text-align: left;
            flex: 1;
            width: 100%;
            max-width: none !important;
        }
        
        .ai-message .message-bubble {
            width: 100% !important;
            max-width: none !important;
            display: block !important;
            box-sizing: border-box !important;
            background: white !important;
            border: 1px solid #e9ecef !important;
            padding: 12px 16px 12px 30px !important;
            margin: 0 !important;
        }
        
        .ai-message .message-bubble * {
            margin-left: 0 !important;
            padding-left: 0 !important;
        }
        
        .loading {
            color: #999;
            font-style: normal;
        }
        
        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4a4a4a;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }
        
        .status-indicator.connected {
            background: #10b981;
        }
        
        .status-indicator.disconnected {
            background: #ef4444;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .prompt-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .prompt-box {
                padding: 20px 15px;
                min-height: 100px;
            }
            
            .prompt-text {
                font-size: 0.9em;
            }
            
            .brand-title {
                font-size: 2em;
            }
        }
        
        @media (max-width: 480px) {
            .prompt-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 20px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="status-indicator" id="status-indicator">
        Backend: Checking...
    </div>
    
    <div class="container">
        <!-- Icon and Branding Section -->
        <div class="icon">
            <img src="/static/docuux.svg" alt="DocuUX Logo" style="width: 80px; height: 80px;">
        </div>
        
        <p class="function-desc">UX Workflow, Thinking & Writing Assistant</p>
        <p class="author-desc">Created by April Ma</p>
        
        <!-- Prompt Boxes Section -->
        <div class="prompt-grid">
            <div class="prompt-box" onclick="selectAgent('workflow')">
                <p class="prompt-text">How can I optimize my UX workflow for enterprise applications?</p>
            </div>
            
            <div class="prompt-box" onclick="selectAgent('thinking')">
                <p class="prompt-text">What's the best approach for user research in B2B contexts?</p>
            </div>
            
            <div class="prompt-box" onclick="selectAgent('writing')">
                <p class="prompt-text">Write a job story for a user who is trying to find help on a new platform.</p>
            </div>
            
            <div class="prompt-box" onclick="selectAgent('triage')">
                <p class="prompt-text">How do I align UX strategy with business goals?</p>
            </div>
        </div>
        
        <!-- Chat Interface -->
        <div class="chat-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0; color: #4a4a4a;">Chat with UX AI Agent</h3>
                <button onclick="startNewChat()" id="new-chat-button" style="background: #f8f9fa; border: 1px solid #e0e0e0; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em; color: #4a4a4a;">New Chat</button>
            </div>
            
            <div class="response-area" id="response-area">
                <p class="loading"></p>
            </div>
            
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="message-input" placeholder="Ask about UX workflows, strategy, or writing..." onkeypress="handleKeyPress(event)">
                <button class="send-button" onclick="sendMessage()" id="send-button">Send</button>
            </div>
        </div>
    </div>

    <script>
        let selectedAgent = null;
        let selectedPrompt = null;
        let currentConversationId = null;

        // Get conversation ID from URL or localStorage
        function getConversationId() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlConvId = urlParams.get('conversation_id');
            if (urlConvId) {
                return parseInt(urlConvId);
            }
            
            const localConvId = localStorage.getItem('currentConversationId');
            if (localConvId) {
                return parseInt(localConvId);
            }
            
            return null;
        }

        // Save conversation ID to URL and localStorage
        function saveConversationId(conversationId) {
            if (conversationId) {
                localStorage.setItem('currentConversationId', conversationId);
                const url = new URL(window.location);
                url.searchParams.set('conversation_id', conversationId);
                window.history.replaceState({}, '', url);
            } else {
                localStorage.removeItem('currentConversationId');
                const url = new URL(window.location);
                url.searchParams.delete('conversation_id');
                window.history.replaceState({}, '', url);
            }
        }

        // Initialize conversation ID
        currentConversationId = getConversationId();

        // Check backend status
        fetch('/health')
            .then(response => response.json())
            .then(data => {
                const statusIndicator = document.getElementById('status-indicator');
                statusIndicator.textContent = 'Backend: Connected';
                statusIndicator.className = 'status-indicator connected';
                
                // Show prompt cards on initial load
                showPromptCards();
                
                // Hide chat area on initial load
                const responseArea = document.getElementById('response-area');
                responseArea.classList.remove('show');
                responseArea.style.display = 'none';
                
                // Load existing conversation if available
                if (currentConversationId) {
                    loadChatHistory(currentConversationId);
                    hidePromptCards(); // Hide cards if there's existing conversation
                }
            })
            .catch(error => {
                const statusIndicator = document.getElementById('status-indicator');
                statusIndicator.textContent = 'Backend: Disconnected';
                statusIndicator.className = 'status-indicator disconnected';
                
                // Show prompt cards even if backend is disconnected
                showPromptCards();
                
                // Hide chat area even if backend is disconnected
                const responseArea = document.getElementById('response-area');
                responseArea.classList.remove('show');
                responseArea.style.display = 'none';
            });

        // Show prompt cards and header info
        function showPromptCards() {
            document.querySelector('.prompt-grid').classList.remove('hide');
            document.querySelector('.function-desc').classList.remove('hide');
            document.querySelector('.author-desc').classList.remove('hide');
        }

        // Hide prompt cards and header info
        function hidePromptCards() {
            document.querySelector('.prompt-grid').classList.add('hide');
            document.querySelector('.function-desc').classList.add('hide');
            document.querySelector('.author-desc').classList.add('hide');
        }

        // Select agent function
        function selectAgent(agentType) {
            console.log('selectAgent called with:', agentType);
            
            // Remove previous selection
            document.querySelectorAll('.prompt-box').forEach(box => {
                box.classList.remove('selected');
            });
            
            // Add selection to clicked box
            event.target.closest('.prompt-box').classList.add('selected');
            
            selectedAgent = agentType;
            selectedPrompt = event.target.closest('.prompt-box').querySelector('.prompt-text').textContent;
            
            console.log('Selected agent:', selectedAgent, 'Selected prompt:', selectedPrompt);
            
            // Auto-fill the input with the selected prompt
            document.getElementById('message-input').value = selectedPrompt;
            document.getElementById('message-input').focus();
            
            // Don't show chat area or hide prompt cards - only fill input
            console.log('Prompt card selected, input filled, chat area remains hidden');
        }

        // Handle Enter key press
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Start new chat function
        function startNewChat() {
            currentConversationId = null;
            selectedAgent = null;
            selectedPrompt = null;
            
            // Clear saved conversation ID
            saveConversationId(null);
            
            // Clear response area
            document.getElementById('response-area').innerHTML = '<p class="loading"></p>';
            
            // Hide chat area
            const responseArea = document.getElementById('response-area');
            responseArea.classList.remove('show');
            responseArea.style.display = 'none'; // Force hide
            
            // Clear input
            document.getElementById('message-input').value = '';
            
            // Remove selection from prompt boxes
            document.querySelectorAll('.prompt-box').forEach(box => {
                box.classList.remove('selected');
            });
            
            // Show prompt cards for new chat
            showPromptCards();
            
            // Focus on input
            document.getElementById('message-input').focus();
        }

        // Add recommended prompts based on AI response
        function addRecommendedPrompts(response, agentType) {
            // Remove any existing recommended prompts
            const existingPrompts = document.querySelectorAll('.recommended-prompts');
            existingPrompts.forEach(prompt => prompt.remove());
            
            // Generate recommended prompts based on agent type and response content
            const recommendations = generateRecommendedPrompts(response, agentType);
            
            if (recommendations.length > 0) {
                const promptContainer = document.createElement('div');
                promptContainer.className = 'recommended-prompts';
                promptContainer.innerHTML = `
                    <div class="recommended-header">ðŸ’¡ Suggested follow-up questions:</div>
                    <div class="recommended-list">
                        ${recommendations.map(prompt => `
                            <div class="recommended-prompt" onclick="useRecommendedPrompt('${prompt.replace(/'/g, "\\'")}')">
                                ${prompt}
                            </div>
                        `).join('')}
                    </div>
                `;
                
                document.getElementById('response-area').appendChild(promptContainer);
            }
        }

        // Function to remove markdown formatting and convert to proper HTML
        function formatResponseText(text) {
            // First, handle headings before other formatting
            let formatted = text
                .replace(/^### (.*$)/gim, '<h3>$1</h3>') // H3 headings
                .replace(/^## (.*$)/gim, '<h2>$1</h2>') // H2 headings
                .replace(/^# (.*$)/gim, '<h1>$1</h1>') // H1 headings
                .replace(/^\- (.*$)/gim, '<li>$1</li>'); // List items
            
            // Handle bold and italic formatting more consistently
            // Process bold first (double asterisks), then italic (single asterisks)
            formatted = formatted
                .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>') // Bold text
                .replace(/\*([^*]+)\*/g, '<em>$1</em>'); // Italic text
            
            // Handle specific patterns from AI responses
            formatted = formatted
                .replace(/<strong>Template:<\/strong>/g, '<h3>Template:</h3>')
                .replace(/<strong>Job Story Development Process:<\/strong>/g, '<h2>Job Story Development Process:</h2>')
                .replace(/<strong>1\. Broad\/Generic Version:<\/strong>/g, '<h3>1. Broad/Generic Version:</h3>')
                .replace(/<strong>2\. More Specific Version:<\/strong>/g, '<h3>2. More Specific Version:</h3>')
                .replace(/<strong>3\. Focused\/Final Version:<\/strong>/g, '<h3>3. Focused/Final Version:</h3>');
            
            // Normalize formatting - ensure consistent bold/italic patterns
            // Handle cases where text should be consistently formatted
            formatted = formatted
                .replace(/(<strong>.*?<\/strong>):/g, '$1:') // Remove extra colons after bold text
                .replace(/(<em>.*?<\/em>):/g, '$1:') // Remove extra colons after italic text
                .replace(/\*\*([^*:]+):\*\*/g, '<strong>$1:</strong>') // Fix bold text with colons
                .replace(/\*([^*:]+):\*/g, '<em>$1:</em>'); // Fix italic text with colons
            
            // Handle paragraph breaks and line breaks
            formatted = formatted
                .replace(/\n\n/g, '</p><p>') // Paragraph breaks
                .replace(/\n/g, '<br>'); // Line breaks
            
            // Wrap in paragraph tags if not already wrapped
            if (!formatted.startsWith('<')) {
                formatted = '<p>' + formatted + '</p>';
            }
            
            return formatted;
        }

        // Generate recommended prompts based on response and agent type
        function generateRecommendedPrompts(response, agentType) {
            const recommendations = [];
            
            // Common follow-up questions
            const commonFollowUps = [
                "Can you provide more details about this?",
                "What are the next steps I should take?",
                "Do you have any examples I can reference?",
                "How can I measure success with this approach?"
            ];
            
            // Agent-specific recommendations
            if (agentType === 'triage') {
                if (response.toLowerCase().includes('strategic') || response.toLowerCase().includes('strategy')) {
                    recommendations.push(
                        "What frameworks can help me align UX with business goals?",
                        "How do I create a UX strategy roadmap?",
                        "What metrics should I track for UX strategy success?"
                    );
                } else if (response.toLowerCase().includes('workflow') || response.toLowerCase().includes('process')) {
                    recommendations.push(
                        "What tools can improve my UX workflow?",
                        "How do I optimize design handoff processes?",
                        "What's the best way to manage UX projects?"
                    );
                } else if (response.toLowerCase().includes('writing') || response.toLowerCase().includes('content')) {
                    recommendations.push(
                        "What's the best approach for UX writing?",
                        "How do I create effective microcopy?",
                        "What guidelines should I follow for content strategy?"
                    );
                }
            } else if (agentType === 'thinking') {
                recommendations.push(
                    "What user research methods should I use?",
                    "How do I create effective user personas?",
                    "What psychological principles apply to this situation?",
                    "How can I validate my assumptions about users?"
                );
            } else if (agentType === 'workflow') {
                recommendations.push(
                    "What tools can streamline this process?",
                    "How do I improve team collaboration?",
                    "What documentation should I create?",
                    "How can I measure workflow efficiency?"
                );
            } else if (agentType === 'writing') {
                recommendations.push(
                    "What tone should I use for this content?",
                    "How do I make this more accessible?",
                    "What's the best way to structure this information?",
                    "How can I test the effectiveness of this copy?"
                );
            }
            
            // Add some common follow-ups
            recommendations.push(...commonFollowUps.slice(0, 2));
            
            // Return unique recommendations (max 4)
            return [...new Set(recommendations)].slice(0, 4);
        }

        // Use recommended prompt
        function useRecommendedPrompt(prompt) {
            document.getElementById('message-input').value = prompt;
            document.getElementById('message-input').focus();
            
            // Remove recommended prompts after selection
            const existingPrompts = document.querySelectorAll('.recommended-prompts');
            existingPrompts.forEach(p => p.remove());
        }

        // Load chat history function
        function loadChatHistory(conversationId) {
            if (!conversationId) return;
            
            fetch(`/api/ux-agent/chat-history/${conversationId}`)
                .then(response => response.json())
                .then(data => {
                    const responseArea = document.getElementById('response-area');
                    responseArea.innerHTML = '<p class="loading"></p>';
                    
                    data.messages.forEach(msg => {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `response-message ${msg.role === 'user' ? 'user-message' : 'ai-message'}`;
                        
                        const time = new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        
                        if (msg.role === 'user') {
                            messageDiv.innerHTML = `
                                <div class="message-avatar user-avatar">U</div>
                                <div class="message-content">
                                    <div class="message-header">
                                        <span class="message-sender">User</span>
                                        <span class="message-time">${time}</span>
                                    </div>
                                    <div class="message-bubble">${msg.content}</div>
                                </div>
                            `;
                        } else {
                            messageDiv.innerHTML = `
                                <div class="message-avatar ai-avatar">AI</div>
                                <div class="message-content">
                                    <div class="message-header">
                                        <span class="message-sender">AI Assistant</span>
                                        <span class="ai-badge">AI</span>
                                        <span class="message-time">${time}</span>
                                    </div>
                                    <div class="message-bubble">${formatResponseText(msg.content)}</div>
                                </div>
                            `;
                        }
                        
                        responseArea.appendChild(messageDiv);
                    });
                    
                    // Scroll to bottom to show latest messages
                    responseArea.scrollTop = responseArea.scrollHeight;
                })
                .catch(error => {
                    console.error('Error loading chat history:', error);
                });
        }

        // Send message function
        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            
            if (!message) {
                alert('Please enter a message or select a prompt!');
                return;
            }

            // If no agent selected, use triage agent
            if (!selectedAgent) {
                selectedAgent = 'triage';
            }

            const responseArea = document.getElementById('response-area');
            const sendButton = document.getElementById('send-button');
            
            // Show chat area
            responseArea.classList.add('show');
            responseArea.style.display = 'block'; // Force display
            
            // Hide prompt cards when sending message
            hidePromptCards();
            
            // Show loading state (don't clear existing messages)
            const loadingMessage = document.createElement('div');
            loadingMessage.className = 'response-message';
            loadingMessage.innerHTML = '<p class="loading">ðŸ¤– AI is thinking...</p>';
            responseArea.appendChild(loadingMessage);
            
            sendButton.disabled = true;
            sendButton.textContent = 'Sending...';
            
            // Disable New Chat button during sending
            const newChatButton = document.getElementById('new-chat-button');
            newChatButton.disabled = true;
            
            // Add user message to response area
            const userMessage = document.createElement('div');
            userMessage.className = 'response-message user-message';
            const currentTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            userMessage.innerHTML = `
                <div class="message-avatar user-avatar">U</div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-sender">User</span>
                        <span class="message-time">${currentTime}</span>
                    </div>
                    <div class="message-bubble">${message}</div>
                </div>
            `;
            responseArea.appendChild(userMessage);
            
            fetch('/api/ux-agent/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    agent_type: selectedAgent || "triage",
                    conversation_id: currentConversationId || null
                })
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                
                // Save conversation ID for future messages
                currentConversationId = data.conversation_id;
                saveConversationId(currentConversationId);
                
                // Remove loading message
                const loadingMessages = responseArea.querySelectorAll('p.loading');
                loadingMessages.forEach(msg => msg.remove());
                
                const aiResponse = document.createElement('div');
                aiResponse.className = 'response-message ai-message';
                const responseTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const agentName = data.agent_used.charAt(0).toUpperCase() + data.agent_used.slice(1) + ' Agent';
                aiResponse.innerHTML = `
                    <div class="message-avatar ai-avatar">AI</div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-sender">${agentName}</span>
                            <span class="ai-badge">AI</span>
                            <span class="message-time">${responseTime}</span>
                        </div>
                        <div class="message-bubble">${formatResponseText(data.response)}</div>
                    </div>
                `;
                responseArea.appendChild(aiResponse);
                
                // Clear input and reset button
                messageInput.value = '';
                sendButton.disabled = false;
                sendButton.textContent = 'Send';
                
                // Re-enable New Chat button
                const newChatButton = document.getElementById('new-chat-button');
                newChatButton.disabled = false;
                
                messageInput.focus();
                
                // Add recommended prompts based on the response
                addRecommendedPrompts(data.response, data.agent_used);
                
                // Scroll to bottom to show the latest response
                setTimeout(() => {
                    responseArea.scrollTop = responseArea.scrollHeight;
                }, 100);
            })
            .catch(error => {
                console.error('Error:', error);
                
                // Remove loading message
                const loadingMessages = responseArea.querySelectorAll('p.loading');
                loadingMessages.forEach(msg => msg.remove());
                
                const errorResponse = document.createElement('div');
                errorResponse.className = 'response-message';
                errorResponse.style.background = '#fef2f2';
                errorResponse.style.borderLeft = '3px solid #ef4444';
                errorResponse.style.color = '#dc2626';
                errorResponse.innerHTML = `<strong>Error:</strong> ${error.message}<br><br>Make sure the backend is running on port 8000`;
                responseArea.appendChild(errorResponse);
                
                // Reset button
                sendButton.disabled = false;
                sendButton.textContent = 'Send';
                
                // Re-enable New Chat button
                const newChatButton = document.getElementById('new-chat-button');
                newChatButton.disabled = false;
            });
        }
    </script>
</body>
</html>
